name: Deploy static site (inject env)

on:
  push:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
  # Use repo-level secrets (remove environment protection to avoid approval stalls)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate SUPABASE secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ] || [ -z "${{ secrets.SUPABASE_KEY }}" ]; then
            echo "ERROR: SUPABASE_URL and SUPABASE_KEY must be configured in repository environment secrets.";
            exit 1;
          fi

      - name: Generate env.js in repo root
        run: |
          echo "Creating env.js in repo root: $PWD"
          ls -l index.html || echo "index.html not found in $PWD"
          cat > env.js <<'EOF'
          // Injected by GitHub Actions during deploy. Do not commit secrets to the repo.
          window.SUPABASE_URL = "${{ secrets.SUPABASE_URL }}";
          window.SUPABASE_KEY = "${{ secrets.SUPABASE_KEY }}";
          if (!window.SUPABASE_URL || !window.SUPABASE_KEY) console.warn('Missing SUPABASE env values');
          EOF

      - name: Verify env.js was created
        run: |
          if [ ! -f env.js ]; then echo "ERROR: env.js not found"; exit 1; fi
          echo "env.js size: $(wc -c < env.js) bytes"
          sha256sum env.js | awk '{print "env.js sha256:", $1}'

      - name: List files in repo root before deploy
        run: |
          echo "Files in repo root (should see index.html and env.js):"
          ls -l .

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
